%define name merge-o-matic-local
%define version %%VERSION%%
%define unmangled_version %%VERSION%%
%define release 1
%define codedir /usr/lib/merge-o-matic

%include %{_rpmconfigdir}/macros.python

Summary: Merge-o-Matic for our distro
Name: %{name}
Version: %{version}
Release: %{release}
Source0: %{name}-%{unmangled_version}.tar.bz2
License: GPL-3.0
Group: System/Packages
Vendor: Alexandre Rostovtsev <alexandre.rostovtsev@collabora.com>

# for /etc/logrotate.d
BuildRequires: logrotate
BuildRequires: python >= 2.7
BuildArch: noarch
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-buildroot

Requires: apt-utils
Requires: deb
Requires: logrotate
Requires: osc
Requires: python-pychart
Requires: python >= 2.7

%description

Merge-o-Matic is a continuous integration tool, used to automatically update
the OBS repository from the corresponding Ubuntu release, and to
provide the necessary information for a developer to perform the update
manually if an automatic update is not possible.

%prep
%setup

%build

%install
make install DESTDIR=%{buildroot}

mkdir -p %{buildroot}/etc/{merge-o-matic,apache2/vhosts.d,logrotate.d,cron.daily}
install -m 0644 mom.conf %{buildroot}/etc/apache2/vhosts.d/mom.conf
install -m 0644 merge-o-matic.logrotate %{buildroot}/etc/logrotate.d/%{name}
install -m 0755 cron.daily %{buildroot}/etc/cron.daily/%{name}

mkdir -p %{buildroot}/srv/obs/merge-o-matic

%pre
if ! getent group | grep "^mom:" &> /dev/null; then
	/usr/sbin/groupadd -r mom
fi
if ! getent passwd | grep "^mom:" &> /dev/null; then
	/usr/sbin/useradd -d /srv/obs/merge-o-matic -M -r -c "Merge-o-Matic" -g mom mom
fi

%clean
rm -rf %{buildroot}

%files
%doc README
%doc COPYING
%dir /etc/merge-o-matic
%config(noreplace) /etc/merge-o-matic/momsettings.py
%dir /etc/apache2
%dir /etc/apache2/vhosts.d
%config(noreplace) /etc/apache2/vhosts.d/mom.conf
%config(noreplace) /etc/logrotate.d/%{name}
%config(noreplace) /etc/cron.daily/%{name}
%dir /srv/obs
%attr(-,mom,mom) %dir /srv/obs/merge-o-matic
/usr/lib/merge-o-matic

%changelog
* Tue Sep 11 2012 Trever Fischer <trever.fischer@collabora.co.uk> - 2012.09.11
- Rough edges cleaned up, some internal design refactoring for easier
  maintainability
- SUITE_A removed

* Wed Sep 05 2012 Trever Fischer <trever.fischer@collabora.co.uk> - 2012.09.05
- MoM no longer allows bad packages to stop processing of all other packages
- Configuration internals are redesigned to reduce redundant configuration
  files.
- Much improved stability and reliability in OBS support.

* Mon Jul 10 2012 Alexandre Rostovtsev <alexandre.rostovtsev@collabora.com> - 2012.07.10
- Use per-target merge output directories.
- Allow MoM to skip committing merges to some osc projects by setting
  DISTROS[distro]["obs"]["commit"] = False in momsettings.py

* Mon Jul 02 2012 Alexandre Rostovtsev <alexandre.rostovtsev@collabora.com> - 2012.07.02
- deal better with missing base versions: try to download them, and if that
  does not help, log the failed merge in the "outstanding" section of the
  HTML reports.

* Fri Jun 22 2012 Alexandre Rostovtsev <alexandre.rostovtsev@collabora.com> - 2012.06.22
- enable support for source groups (multiple source distros for a package in a target)
- explicitly and properly define distribution targets

* Tue Jun 19 2012 Alexandre Rostovtsev <alexandre.rostovtsev@collabora.com> - 2012.06.19
- enable support for multiple source distros for each target

* Tue Apr 10 2012 Alexandre Rostovtsev <alexandre.rostovtsev@collabora.com> - 2012.04.10-1
- initial version

