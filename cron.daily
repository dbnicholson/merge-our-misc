#!/bin/bash
# cron.daily - crontab script to run mom
#
# Copyright Â© 2008 Canonical Ltd.
# Author: Scott James Remnant <scott@ubuntu.com>.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of version 3 of the GNU General Public License as
# published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

set -e
umask 002

ROOT="/srv/obs/merge-o-matic"
CODE="/usr/lib/merge-o-matic"
LOG="/var/log/mom.log"

echo >> "$LOG"

if [ "$DEBUG" = "y" ]; then
	QUIET=""
else
	QUIET="-q"

	if ! mkdir "$ROOT/.lock" 2>/dev/null; then
		echo "LOCKED (another one running?)" &>> "$LOG"
		exit 1
	fi
	trap "rmdir $ROOT/.lock" 0 &>> "$LOG"
fi

cd "$ROOT" &>> "$LOG"
#git pull

cp addcomment.py /srv/merge-o-matic/merges &>> "$LOG"

# Update the blacklist
#wget -q -O$ROOT/sync-blacklist.txt http://people.canonical.com/~ubuntu-archive/sync-blacklist.txt &> "$LOG"

# Download new packages
"$CODE"/update-pool.py $QUIET ubuntu DISTRO-standard &>> "$LOG"

# Update the Sources files against new packages that have been downloaded.
"$CODE"/update-sources.py $QUIET &>> "$LOG"

# Generate changes, diffs and patches
"$CODE"/generate-diffs.py $QUIET &>> "$LOG"
"$CODE"/generate-patches.py $QUIET &>> "$LOG"
"$CODE"/generate-dpatches.py $QUIET &>> "$LOG"

# Publish the Ubuntu patches so that Debian people can get at them
"$CODE"/publish-patches.py $QUIET &>> "$LOG"
"$CODE"/syndicate.py $QUIET &>> "$LOG"
# "$CODE"/mail-bugs.py $QUIET

# Run the merge tool
"$CODE"/produce-merges.py -X merge-blacklist.txt &>> "$LOG"

# Commit committable changes to OBS
"$CODE"/commit-merges.py $QUIET &>> "$LOG"

# Produce pretty reports
"$CODE"/stats.py $QUIET &>> "$LOG"
"$CODE"/stats-graphs.py $QUIET &>> "$LOG"
"$CODE"/merge-status.py $QUIET &>> "$LOG"
"$CODE"/manual-status.py $QUIET &>> "$LOG"

# Expire any old packages from the pool
$CODE/expire-pool.py $QUIET &>> "$LOG"

# ?! untidy
rm -rf "$ROOT"/unpacked/* &>> "$LOG"
